---
title: "network_analysis"
author: "Erica Ryu"
date: "6/6/2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 15. Network Analysis

## The purpose of this script is to generate a network of the oral microbiome

## load packages
```{r}
library(phyloseq)
library(SpiecEasi)
library(Matrix)
library(data.table)
library(dplyr)
library(tidyr)
library(igraph)
library(ggplot2)
library(magrittr)
library(boot)
```

## load data
```{r}
# rarefied oral microbiome
rarefied_phyloseq <- readRDS("output/rarefied_phyloseq.rds")

# subset based on extraction kit
rarefied_qiagen <- subset_samples(rarefied_phyloseq, Condition == "Qiagen")
```

## prep oral microbiome data
```{r}
phy_genus <- tax_glom(rarefied_qiagen, "Genus", NArm = FALSE);phy_genus
otu_table <- as.data.frame(as.matrix(phy_genus@otu_table))

setDT(otu_table, keep.rownames = TRUE)[]
colnames(otu_table)[1] <- "SampleID"

otu_table2 <- otu_table %>% data.frame %>% magrittr::set_rownames(.$SampleID)
otu_table2 <- otu_table2[,-1]
otu_table2 <- t(otu_table2)
tax_table <- as.data.frame(as.matrix(phy_genus@tax_table))

otu_tax <- merge(otu_table2, tax_table, by = 0, all = TRUE)

# change colnames to genus name
otu_tax$Genus <- replace_na(otu_tax$Genus, "_unclassified")
# and add higher taxonomic level to unclassified
otu_tax$Phylum <- ifelse(is.na(otu_tax$Phylum), otu_tax$Kingdom, otu_tax$Phylum)
otu_tax$Class <- ifelse(is.na(otu_tax$Class), otu_tax$Phylum, otu_tax$Class)
otu_tax$Order <- ifelse(is.na(otu_tax$Order), otu_tax$Class, otu_tax$Order)
otu_tax$Family <- ifelse(is.na(otu_tax$Family), otu_tax$Order, otu_tax$Family)

otu_tax$Genus <- ifelse(otu_tax$Genus == "_unclassified", paste(otu_tax$Family, otu_tax$Genus, sep = ""), otu_tax$Genus)

# remove completely unclassified taxon
otu_tax <- otu_tax[!is.na(otu_tax$Kingdom),]

# make genus rownames
rownames(otu_tax) <- otu_tax$Genus
# and remove taxonomic columns
otu_tax <- subset(otu_tax, select = -c(Row.names, Kingdom, Phylum, Class, Order, Family, Genus))

otu_tax_t <- t(otu_tax)
```

## run sparcc
```{r}
set.seed(203)
sparcc_output <- sparcc(otu_tax_t)
```

## format sparcc outputs
```{r}
# Define threshold for SparCC correlation matrix for the graph
sparcc.graph <- abs(sparcc_output$Cor) >= 0.5
diag(sparcc.graph) <- 0
sparcc.graph <- Matrix(sparcc.graph, sparse=TRUE)
# Create igraph object
ig.sparcc <- adj2igraph(sparcc.graph, vertex.attr=list(name=rownames(otu_tax)))
# apply layout
am.coord <- layout.fruchterman.reingold(ig.sparcc)
```

## centrality
```{r}
degr_cent_sparcc <- centr_degree(ig.sparcc, mode = 'all')
degr_cent_sparcc <- degr_cent_sparcc$res

# Compute betweenness centrality
betw_cent_sparcc <- igraph::betweenness(ig.sparcc)

# make into one dataframe
sparcc_cent <- data.frame(label = rownames(otu_tax),
                   degree = degr_cent_sparcc, 
                   betweeness = betw_cent_sparcc)

# plot histogram of degree distributions
ggplot(data = sparcc_cent, aes(x = degree)) +
  geom_bar(alpha = .5, position = 'identity') +
  ggtitle('Degree distribution')


```

## examine taxa with at least one edge
```{r}
# plot taxa with at least one edge
isolated_sparcc <- which(degree(ig.sparcc)==0)
ig.sparcc_wo0 <- delete.vertices(ig.sparcc, isolated_sparcc)
am.coord_sparcc <- am.coord[-isolated_sparcc,]
plot(ig.sparcc_wo0, 
    vertex.size = 5+degr_cent_sparcc,   # Change node size
     vertex.shape = 'circle',      # Specify node shape
     asp = 0,  layout = am.coord_sparcc)

# get centrality only for taxa with edges
sparcc_cent_wo0 <- filter(sparcc_cent, degree != 0)
```

## get edge weights
```{r}
# extract weights
elist.sparcc <- summary(sparcc.graph*sparcc_output$Cor)
edges <- elist.sparcc$x

# connect taxa names to indices
index <- 1:length(rownames(otu_tax))
index_df <- as.data.frame(cbind(rownames(otu_tax), index))
colnames(index_df) <- c("taxa", "index")

# change index to name
elist.sparcc[] <- index_df$taxa[match(unlist(elist.sparcc), index_df$index)]

# add weights
elist.sparcc$x <- edges
```

## make CAGs
```{r}
set.seed(101)
mod_groups_sparcc_wo0 <- cluster_fast_greedy(ig.sparcc_wo0)
mod_groups_sparcc_wo0_plot <- mod_groups_sparcc_wo0$membership

modularity(mod_groups_sparcc_wo0)

clusterOneIndices_sparcc <- which(mod_groups_sparcc_wo0$membership==1)
clusterOneOtus_sparcc <- mod_groups_sparcc_wo0$names[clusterOneIndices_sparcc]
clusterTwoIndices_sparcc <- which(mod_groups_sparcc_wo0$membership==2)
clusterTwoOtus_sparcc <- mod_groups_sparcc_wo0$names[clusterTwoIndices_sparcc]
clusterThreeIndices_sparcc <- which(mod_groups_sparcc_wo0$membership==3)
clusterThreeOtus_sparcc <- mod_groups_sparcc_wo0$names[clusterThreeIndices_sparcc]
clusterFourIndices_sparcc <- which(mod_groups_sparcc_wo0$membership==4)
clusterFourOtus_sparcc <- mod_groups_sparcc_wo0$names[clusterFourIndices_sparcc]
clusterFiveIndices_sparcc <- which(mod_groups_sparcc_wo0$membership==5)
clusterFiveOtus_sparcc <- mod_groups_sparcc_wo0$names[clusterFiveIndices_sparcc]
clusterSixIndices_sparcc <- which(mod_groups_sparcc_wo0$membership==6)
clusterSixOtus_sparcc <- mod_groups_sparcc_wo0$names[clusterSixIndices_sparcc]
clusterSevenIndices_sparcc <- which(mod_groups_sparcc_wo0$membership==7)
clusterSevenOtus_sparcc <- mod_groups_sparcc_wo0$names[clusterSevenIndices_sparcc]

# combine into one dataframe
CAGs <- stack(mget(c("clusterOneOtus_sparcc", "clusterTwoOtus_sparcc", "clusterThreeOtus_sparcc", "clusterFourOtus_sparcc", "clusterFiveOtus_sparcc", "clusterSixOtus_sparcc", "clusterSevenOtus_sparcc")))
```

## save tables for input into cytoscope for visualization
```{r}
# write.table(elist.sparcc, file = "output/sparcc_edges.txt")
# write.graph(ig.sparcc_wo0, file="output/sparcc_rarefied.txt", format="ncol")
taxtable <- as.data.frame(as.matrix(phy_genus@tax_table))
# write.table(taxtable, file="output/taxtable.txt",sep="\t", quote=FALSE)
# write.table(CAGs, file="output/CAGs.txt",sep="\t", quote=FALSE)
```

## compare DA taxa to not DA
```{r}
## all taxa
# find avg number of edges for DA taxa
DA_taxa <- c("Streptobacillus", "Porphyromonadaceae_unclassified", "Granulicatella", "Moraxella", "Simonsiella", "Neisseria", "Bacteroidetes_unclassified", "Brachymonas", "Atopobium")

DA_cent <- subset(sparcc_cent, label %in% DA_taxa)
DA_mean <- mean(DA_cent$degree)

# bootstrap avg number of edges for all other taxa
non_DA_cent <- subset(sparcc_cent, !(label %in% DA_taxa))

# create function
bootFunc <- function(data, i){
df <- data[i, ]
sample <- sample(df$degree, size = 9, replace = TRUE)
mean(sample)
}

# run bootstrap
set.seed(123)
boot_non_DA <- boot(non_DA_cent, bootFunc, R = 1000)

print(boot_non_DA)
ci <- boot.ci(boot_non_DA, index = 1)

plot_boot_non_DA <- as.data.frame(boot_non_DA$t)

# calculate p value
## filter to values equal to or above observed value
plot_boot_non_DA_sig <- filter(plot_boot_non_DA, V1 >= DA_mean)

## get p value
pval_nonDA <- nrow(plot_boot_non_DA_sig)/nrow(plot_boot_non_DA)

# plot
finplot_boot_non_DA <- ggplot(plot_boot_non_DA, aes(x = V1)) +
    geom_histogram(binwidth = 0.2, center = 0.11, fill = "dark grey") +
    geom_vline(xintercept = DA_mean, lty = 2, color = "red") +
    labs(x = "Average Centrality", y = "Count") +
    theme(axis.text.x = element_text(hjust = 0.95, vjust=0.95)) + 
    theme(legend.position = "none")

# ggsave(file="output/finplot_boot_non_DA.svg", plot=finplot_boot_non_DA, width=6, height=3)
```

